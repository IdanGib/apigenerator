<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API</title>
    <link rel="stylesheet" href="index.css">
 
    <link rel="stylesheet" href="lib/codemirror-5.61.0/lib/codemirror.css">
    <link rel="stylesheet" href="lib/codemirror-5.61.0/addon/hint/show-hint.css">

    <script src="lib/codemirror-5.61.0/lib/codemirror.js"></script>
    <script src="lib/codemirror-5.61.0/addon/hint/show-hint.js"></script>
    <script src="lib/codemirror-5.61.0/addon/hint/javascript-hint.js"></script>
    <script src="lib/codemirror-5.61.0/addon/edit/closebrackets.js"></script>
    <script src="lib/codemirror-5.61.0/mode/javascript/javascript.js"></script>


    
</head>
<body>
    <div class='app'>
        <div class='header'>API</div>
        <div class='list'>

            <div class="create-api">
                <input id="createname" type="text" id="apiname" placeholder="name" >
                <button id="createbtn">create</button>
            </div>
            <div id="apis"></div>
        </div>
        <div class='editor'>
            <div calss='editor-header'>
                <input type="text" id="updatename"  disabled>
                <button id="updatebtn" disabled>save</button>
                <span id="saveloader"></span>
            </div>
            <!--textarea 
                spellCheck="false" 
                id="updatecontent" 
                cols="30" 
                rows="10">
            </textarea -->
            <textarea id="updatecontent" ></textarea>
        </div>
        <div class="global">
            <div>
                <h3>dependencies</h3>
                <div id='dependencies'></div>
            </div>
        </div>
        <div class='footer'></div>
    </div>

    <script src="/index.js"></script>

    <script>
        function g(id) {
            return document.getElementById(id);
        }
        const elements = {
            apis: g('apis'),
            dependencies: g('dependencies'),
            createbtn: g('createbtn'),
            createname: g('createname'),
            pkg: g('pkg'),
            pkgcontent: g('pkg-content'),
            updatecontent: g('updatecontent'),
            updatename: g('updatename'),
            updatebtn: g('updatebtn'),
            saveLoader: g('saveloader')
        };
        const env = { url: `http://localhost:3000` };

        api.init({ elements, env }).then(async api => {

            const { 
                apis,
                dependencies,
                createbtn, 
                updatecontent, 
                updatebtn, 
                updatename,
                saveLoader
            } = elements;
            let current = '';
            async function save() {
                saveLoader.innerText = 'saving...';
                const content = codeMirror.getValue();
                const name =  updatename.value;   
                const { data, err } = await api.update(name, content);
                saveLoader.innerText = '';
                current = codeMirror.getValue();
            }

            const codeMirror = CodeMirror.fromTextArea(updatecontent, {
                mode:  "javascript",
                lineNumbers: true,
                autoCloseBrackets: true,
                autocorrect: true,
                extraKeys: {
                    "Ctrl-Space": "autocomplete", 
                    "Ctrl-S": save,
                }
            });

            codeMirror.on('change', (cm, data) => {
                const changed = current !== cm.getValue();
                const action = changed ? 'removeAttribute' :  'setAttribute';
                updatebtn[action]('disabled', '');
            });

            async function editor(name, content) {
                codeMirror.setValue(content);
                updatename.value = name;
            }

            async function loadApiItem(name) {
                const { data, err } = await api.read(name);
                const content = data || '';
                current = content;
                editor(name, content);
            }

            async function updateList() {
                const { data } = await api.list();
       
                const list = data.map(name => {
                    const item = document.createElement('div');
                    item.innerText = name;
                    item.classList.add('item');

                    const open = document.createElement('button');
                    open.innerText = 'open';
                    open.onclick = async event => {
                        await loadApiItem(name);
                    };

                    const removebtn = document.createElement('button');
                    removebtn.innerText = 'delete';
                    removebtn.onclick = async event => {
                        await api.delete(name);
                        updateView();
                    };
                    const actions = document.createElement('div');

                    actions.appendChild(open);
                    actions.appendChild(removebtn);
                    item.appendChild(actions);
                    return item;  
                });
                apis.innerText = '';
                for(const li of list) {
                    apis.appendChild(li);
                }

            }

            async function getDependencies() {
                const json = await api.package();
                const deps = Object.keys(json.dependencies);
                const depsHTML = deps.map(d => `<div>${d}</div>`).join('');
                dependencies.innerHTML = depsHTML;
            }
    
            async function updateView() {
                await updateList();
                editor('', '');
                getDependencies();
            }
        
            

            updatebtn?.addEventListener('click', save);

            createbtn?.addEventListener('click', async event => {
                const name = createname.value;
                if(name) {
                    await api.create(name);
                    createname.value = '';
                    updateView();
                }
            });

            updateView();



        }).catch(console.error);
    </script>
</body>
</html>