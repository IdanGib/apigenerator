<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class='app'>
        <div class='header'>API</div>
        <div class='list'>

            <div class="create-api">
                <input id="createname" type="text" id="apiname" placeholder="name" >
                <button id="createbtn">create</button>
            </div>
            <div id="apis"></div>
        </div>
        <div class='editor'>
            <div calss='editor-header'>
                <input type="text" id="updatename"  disabled>
                <button id="updatebtn">update</button>
            </div>
            <textarea resize="off" id="updatecontent" cols="30" rows="10"></textarea>

        </div>
        <div class='footer'></div>
    </div>

    <script src="/index.js"></script>

    <script>
        function g(id) {
            return document.getElementById(id);
        }
        const elements = {
            apis: g('apis'),

            createbtn: g('createbtn'),
            createname: g('createname'),

            updatecontent: g('updatecontent'),
            updatename: g('updatename'),
            updatebtn: g('updatebtn')
        };
        const env = { url: `http://localhost:3000` };

        api.init({ elements, env }).then(async api => {

            const { 
                apis, 
                createbtn, 
                updatecontent, 
                updatebtn, 
                updatename 
            } = elements;

            async function editor(name, content) {
                updatecontent.value = content;
                updatename.value = name;
            }

            async function loadApiItem(name) {
                const { data, err } = await api.read(name);
                const content = data || '';
                editor(name, content);
            }

        

            async function updateList() {
                const { data } = await api.list();
       
                const list = data.map(name => {
                    const item = document.createElement('div');
                    item.innerText = name;
                    item.classList.add('item');

                    const open = document.createElement('button');
                    open.innerText = 'open';
                    open.onclick = async event => {
                        await loadApiItem(name);
                    };

                    const removebtn = document.createElement('button');
                    removebtn.innerText = 'delete';
                    removebtn.onclick = async event => {
                        await api.delete(name);
                        updateView();
                    };
                    const actions = document.createElement('div');

                    actions.appendChild(open);
                    actions.appendChild(removebtn);
                    item.appendChild(actions);
                    return item;  
                });
                apis.innerText = '';
                for(const li of list) {
                    apis.appendChild(li);
                }

            }

    
            async function updateView() {
                await updateList();
                editor('', '');
            }
        
            updatebtn?.addEventListener('click', async event => {
                const content = updatecontent.value;
                const name =  updatename.value;              
                const { data, err } = await api.update(name, content);
            })

            createbtn?.addEventListener('click', async event => {
                const name = createname.value;
                if(name) {
                    await api.create(name);
                    updateView();
                }
            });
            updateView();
        }).catch(console.error);
    </script>
</body>
</html>